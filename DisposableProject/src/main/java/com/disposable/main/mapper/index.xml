<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disposable.main.dao.indexdao">
	<select id="storeList" resultType="java.util.Map" parameterType="java.util.Map">
	SELECT SP.* 
	,(SELECT COUNT(*) FROM SHOP  
		<if test="classify != '' and classify != null">
		WHERE CLASSIFY = #{classify}
		</if>
	) AS TOTALCNT
	FROM(
		SELECT STORENUM,STORENAME,PHOTO,ROWNUM as RM FROM SHOP 
		<if test="classify != '' and classify != null">
			WHERE CLASSIFY = #{classify}
		</if>
		) SP
		WHERE SP.RM > #{startPage} AND #{endPage} > SP.RM 
	</select>
	<select id="bestStoreList" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT * FROM 
	(SELECT AA.*,ROWNUM AS RM FROM
	(SELECT *
	FROM (SELECT STORENUM,COUNT(*) AS ORDERCNT FROM ORDERFOOD GROUP BY STORENUM ORDER BY ORDERCNT) OFD
	INNER JOIN SHOP SH
	ON OFD.STORENUM = SH.STORENUM)AA)BB
	WHERE 11 > BB.rm
	</select>
	
	<select id="AllStoreList" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT * FROM SHOP WHERE LATITUDE IS NOT NULL
	</select>
	
	<select id="SaleFoodList" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT * 
			FROM FOOD FD
			LEFT JOIN ( SELECT B.* FROM (SELECT ROW_NUMBER() OVER(PARTITION BY A.BOARDNUM 
			ORDER BY A.IMGNAME,A.BOARDNUM) AS ROW_NUM,A.* FROM IMAGEBOX A WHERE A.CLASSIFY='SHOP') B WHERE 
			B.ROW_NUM = 1 ) IB
			ON FD.FOODNUM = IB.BOARDNUM
			INNER JOIN SHOP SP
			ON FD.STORENUM = SP.STORENUM 
			 WHERE FD.SALEPERCENT != 0
			 AND SALEDATE > (sysdate + 9/24)
			 ORDER BY SALEDATE
	</select>
	
	<select id="getAroundstoreList" resultType="java.util.Map" parameterType="java.util.Map">
		SELECT * 
		FROM SHOP
		 WHERE LATITUDE IS NOT NULL
		 <if test="classify !='' and classify != null">
		 	AND CLASSIFY = #{classify}
		 </if>
		 <if test="storename !='' and storename != null">
		 	AND STORENAME LIKE '%'||#{storename}||'%'
		 </if>
	</select>
	
	
	
<select id="RecommendFoodList" resultType="java.util.Map" parameterType="String">	
SELECT * FROM
	(SELECT
		aa.*,ROWNUM as rn
	FROM (
		SELECT  
			OFD.STORENUM
			,OFD.FOODNUM 
			, COUNT(OFD.FOODNUM) AS ORDERCOUNT
			,FD.FOODNAME 
			,FD.PRICE
			,FD.SALEPERCENT
			,FD.SALEDATE
			,SP.STORENAME
			,IB.IMGNAME
		FROM ORDERFOOD OFD
		INNER JOIN FOOD FD
		ON OFD.FOODNUM = FD.FOODNUM
		AND OFD.STORENUM = FD.STORENUM
		LEFT JOIN 
		( SELECT B.* FROM (SELECT ROW_NUMBER() OVER(PARTITION BY A.BOARDNUM 
			ORDER BY A.IMGNAME,A.BOARDNUM) AS ROW_NUM,A.* FROM IMAGEBOX A WHERE A.CLASSIFY='SHOP') B WHERE 
			B.ROW_NUM = 1 ) IB
		ON FD.FOODNUM = IB.BOARDNUM
		INNER JOIN SHOP SP
		ON OFD.STORENUM = SP.STORENUM
		GROUP BY 
			OFD.FOODNUM
			,OFD.STORENUM
			,FD.FOODNAME 
			,FD.PRICE
			,FD.SALEPERCENT
			,FD.SALEDATE
			,SP.STORENAME
			,IB.IMGNAME
		ORDER BY ORDERCOUNT DESC
		) aa 
	) BB
<if test="Flag != ''  and Flag != null">
WHERE  9 > BB.rn
</if>
</select>
	
	
	
</mapper>