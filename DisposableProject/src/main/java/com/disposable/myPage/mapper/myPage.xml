<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disposable.myPage.dao.myPageDao">
<select id="userOrderList" parameterType="java.util.Map"  resultType="java.util.Map">
			SELECT 
				OFD.STORENUM
					,OFD.ALLPRICE
					,OFD.EMAIL
					,OFD.ORDERCODE
					,LISTAGG(OFD.OPTIONS, '**') WITHIN GROUP (ORDER BY OFD.ORDERCODE) AS OPTIONS
					,OFD.STATES
					,OFD.MEMO
					,LISTAGG(FD.FOODNAME, '**') WITHIN GROUP (ORDER BY OFD.OPTIONS) AS FOODNAME
					,to_char(OFD.ORDERDATE, 'yyyy-mm-dd hh:mi:ss') AS ORDERDATE
					,SP.PHOTO AS PHOTO
				FROM ORDERFOOD OFD
				INNER JOIN FOOD FD
				ON OFD.FOODNUM = FD.FOODNUM
				AND OFD.STORENUM = FD.STORENUM
				
				INNER JOIN MEMBERS MBS
				ON OFD.EMAIL = MBS.EMAIL
				LEFT JOIN SHOP SP
				ON OFD.STORENUM = SP.STORENUM
				WHERE OFD.EMAIL =#{email}
				<if test="states != ''  and states != null and states != 'PICKUP'">
					AND STATES IN ('PAY','TAKE')
				</if>
				<if test="states != ''  and states != null and states == 'PICKUP'">
					AND STATES = #{states}
				</if>
					GROUP BY 
					OFD.STORENUM
					,OFD.ALLPRICE
					,OFD.EMAIL
					,OFD.ORDERCODE
					,OFD.STATES
					,OFD.MEMO
					,OFD.ORDERDATE
					,SP.PHOTO
	</select>

</mapper>