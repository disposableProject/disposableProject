<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disposable.shop.dao.shopDao">

	<select id="shopMain" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * 
			FROM FOOD FD
			LEFT JOIN ( SELECT B.* FROM (SELECT ROW_NUMBER() OVER(PARTITION BY A.BOARDNUM 
			ORDER BY A.IMGNAME,A.BOARDNUM) AS ROW_NUM,A.* FROM IMAGEBOX A WHERE A.CLASSIFY='SHOP') B WHERE 
			B.ROW_NUM = 1 ) IB
			ON FD.FOODNUM = IB.BOARDNUM
			 WHERE FD.STORENUM = #{storenum}
			 <if test="foodnum != '' and foodnum != null">
			AND FD.FOODNUM = #{foodnum}
			</if>
	</select>
	
	<select id="getFoodOption" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * 
		FROM FOODOPTION 
		WHERE STORENUM = #{storenum} 
		AND FOODNUM = #{foodnum} 
		ORDER BY OPTIONGROUP,OPTIONNUM
	</select>
	
	<select id="getStoreInfo" parameterType="String" resultType="java.util.Map">
		SELECT * FROM SHOP WHERE STORENUM = #{storenum}
	</select>
	
	<!-- 주문서 생성 -->
	<insert id="orderInsert" parameterType="java.util.Map">
		INSERT INTO ORDERFOOD (ORDERNUM, STORENUM, FOODNUM, ALLPRICE, EMAIL, ORDERCODE, OPTIONS, OPTIONPRICE, ORDERDATE, STATES)
		VALUES (ORDER_SEQ.NEXTVAL, #{storenum}, #{foodnum}, #{price}, #{email}, #{ordercode}, #{options}, #{optionprice}, sysdate, 'NEW')
	</insert>
	
	<!-- 주문 정보 -->
	<select id="orderPayment" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT * 
		FROM ORDERFOOD ODF
		INNER JOIN FOOD FO
		ON ODF.STORENUM = FO.STORENUM
		AND ODF.FOODNUM = FO.FOODNUM
		WHERE ODF.EMAIL = #{email}
		AND ODF.ORDERCODE = #{orderCode}
	</select>
	
	<!-- 댓글 작성 -->
	<insert id="writeReview" parameterType="java.util.Map">
		INSERT INTO REVIEW (REVIEWNUM, FOODNUM, STORENUM, NICKNAME, EMAIL, REVIEW, PHOTO, WDATE)
		VALUES (REVIEW_SEQ.NEXTVAL, #{foodnum}, #{storenum}, #{nickname}, #{email}, #{review}, #{photo}, CURRENT_DATE)
	</insert>
	
</mapper>