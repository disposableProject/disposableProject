<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.disposable.management.dao.managementDao">
	<insert id="foodMainInsert" parameterType="java.util.Map">
			INSERT INTO FOOD (FOODNUM,STORENUM,FOODNAME,PRICE,WAITTIME,FOODPHOTO,FOOTTEXT)
			VALUES (FOOD_SEQ.NEXTVAL,#{storeNum},#{foodName},#{foodPrice},#{waitTime},'','')
	</insert>
	<insert id="foodOptionInsert" parameterType="java.util.Map">
			 INSERT INTO FOODOPTION (FOODNUM,STORENUM,OPTIONNUM,OPTIONGROUP,PRICE,CHECKFLAG,OPTIONGRNAME,OPTIONNAME)
			VALUES (FOOD_SEQ.CURRVAL,#{storeNum},#{optionNum},#{optionGroupNum},#{optionPrice},#{multiple},#{optionGroupName},#{optionName})
	</insert>
	<insert id="foodImageInsert" parameterType="String">
			 INSERT INTO IMAGEBOX (IMGNUM,BOARDNUM,IMGNAME,CLASSIFY)
			VALUES (IMAGEBOX_SEQ.NEXTVAL,FOOD_SEQ.CURRVAL,#{value},'SHOP')
	</insert>
	<select id="storeFoodListGet" parameterType="java.util.Map" resultType="java.util.Map">
		SELECT MT.*,
		(SELECT COUNT(*)
			FROM SHOP SP
			INNER JOIN FOOD FD
			ON SP.STORENUM = FD.STORENUM
			LEFT JOIN (SELECT IMGNAME,BOARDNUM FROM IMAGEBOX WHERE CLASSIFY='SHOP' AND 1 >= ROWNUM) IB
			ON FD.FOODNUM = IB.BOARDNUM
			WHERE SP.STORENUM = #{storenum}) as TOTALCNT
			 FROM
			(
			SELECT FD.*,
			IB.IMGNAME,
			ROWNUM as RM
			FROM SHOP SP
			INNER JOIN (SELECT * FROM FOOD ORDER BY FOODNUM DESC) FD
			ON SP.STORENUM = FD.STORENUM
			LEFT JOIN (
			SELECT B.* FROM
			(SELECT ROW_NUMBER() OVER(PARTITION BY A.BOARDNUM ORDER BY A.IMGNAME,A.BOARDNUM) AS ROW_NUM,A.* 
			FROM IMAGEBOX A WHERE A.CLASSIFY='SHOP') B
			 WHERE B.ROW_NUM = 1
			 ) IB
			ON FD.FOODNUM = IB.BOARDNUM
			WHERE SP.STORENUM = #{storenum}
			) MT
			WHERE
			MT.RM > #{startpagenum}  AND  #{endpagenum} >= MT.RM
			
	</select>
	<select id="storeOrderList" parameterType="java.util.Map"  resultType="java.util.Map">
			SELECT 
					OFD.ORDERNUM
					,OFD.STORENUM
					,OFD.FOODNUM
					,OFD.ALLPRICE
					,OFD.EMAIL
					,OFD.ORDERCODE
					,OFD.OPTIONS
					,OFD.STATES
					,OFD.MEMO
					,FD.FOODNAME
					,to_char(OFD.ORDERDATE, 'yyyy-mm-dd hh:mi:ss') AS ORDERDATE

				FROM ORDERFOOD OFD
				INNER JOIN (SELECT * FROM FOOD WHERE STORENUM =#{storenum}) FD
				ON OFD.FOODNUM = FD.FOODNUM
				INNER JOIN MEMBERS MBS
				ON OFD.EMAIL = MBS.EMAIL
				WHERE OFD.STORENUM = #{storenum}
				<if test="state != ''  and state != null">
				AND STATES = #{state}
				</if>
	</select>
	<update id="updateOrder" parameterType="java.util.Map">
			UPDATE ORDERFOOD 
			SET STATES = #{state}
			WHERE ORDERCODE = #{ordercode}
	</update>
	<select id="shopInfo" parameterType="String"  resultType="java.util.Map">
		SELECT * FROM SHOP WHERE STORENUM = #{storenum}
	</select>
</mapper>
